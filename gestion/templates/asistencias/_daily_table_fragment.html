{# Fragmento reutilizable para la sección diaria que puede ser reemplazada por HTMX tras activar la sesión #}
<div id="daily-attendance-fragment">
    <div class="mb-2">
        {# Añadimos botón de descarga diaria; se asume que la vista recibe `grupo` y `session_active` en el contexto #}
    {% if grupo %}
        {% if session_active %}
            <a href="{% url 'download_asistencias_diaria' grupo=grupo fecha=fecha|date:'Y-m-d' %}?format=xlsx" class="btn btn-outline-success btn-sm">Descargar Reporte Diario</a>
            {# Botón de desactivar visible sólo para administradores (superuser o rol ADMINISTRADOR) #}
            {% if request.user.is_superuser or request.user.rol == 'ADMINISTRADOR' %}
                {# Add a bit more left margin so the deactivate button is visually separated from the download link #}
                <form hx-post="{% url 'deactivate_session_day' %}" hx-target="#daily-attendance-fragment" hx-swap="outerHTML" method="POST" class="d-inline ms-3" onsubmit="(function(btn){btn.disabled=true; btn.innerText='Desactivando...';})(this.querySelector('button[type=submit]'))">
                    {% csrf_token %}
                    <input type="hidden" name="grupo" value="{{ grupo }}">
                    <input type="hidden" name="fecha" value="{{ fecha|date:'Y-m-d' }}">
                    <button type="submit" class="btn btn-outline-danger btn-sm">Desactivar sesión</button>
                </form>
            {% endif %}
        {% else %}
            <button type="button" class="btn btn-outline-secondary btn-sm" disabled title="La sesión no está activa. Activa la sesión para descargar el reporte">Descargar Reporte Diario</button>
        {% endif %}
    {% endif %}
    
    {# Buscador cliente por nombre que filtra las filas ya renderizadas #}
    <div class="mb-3">
        <input id="attendance-search" type="search" class="form-control form-control-sm" placeholder="Buscar por nombre..." aria-label="Buscar por nombre">
    </div>
    {# Mostrar banner de activación de sesión si no está activa. 'session_active' debe estar en el contexto. #}
    {% if grupo and not session_active %}
    <div class="alert alert-warning d-flex justify-content-between align-items-center">
        <div>La sesión de entrenamiento para este día está inactiva. ¿Deseas activarla para registrar asistencias y que aparezca en los reportes?</div>
        <form hx-post="{% url 'activate_session_day' %}" hx-target="#daily-attendance-fragment" hx-swap="outerHTML" method="POST" class="mb-0" onsubmit="(function(btn){btn.disabled=true; btn.innerText='Activando...';})(this.querySelector('button[type=submit]'))" hx-on='htmx:afterRequest: (event)=>{ if(event.detail && event.detail.xhr && event.detail.xhr.status >= 400){ let b=this.querySelector("button[type=submit]"); if(b){ b.disabled=false; b.innerText="Activar sesión"; } } }'>
            {% csrf_token %}
            <input type="hidden" name="grupo" value="{{ grupo }}">
            <input type="hidden" name="fecha" value="{{ fecha|date:'Y-m-d' }}">
            <button type="submit" class="btn btn-primary btn-sm">Activar sesión</button>
        </form>
    </div>
    {% endif %}

    {% regroup estudiantes by grupo as grouped_students %}
    {% for group in grouped_students %}
        <h2 class="d-flex flex-column flex-md-row align-items-start justify-content-between">Grupo: {{ group.grouper }}
            <small class="text-muted d-flex flex-column flex-md-row gap-2 mt-2 mt-md-0 align-items-start align-items-md-center">
                <span class="d-block">Asistentes: <strong id="attendance-count-{{ forloop.counter }}">0</strong></span>
                <span class="d-block">Inasistentes: <strong id="absent-count-{{ forloop.counter }}">0</strong></span>
            </small>
        </h2>

        <div class="table-responsive">
        <table class="table table-striped table-bordered mb-4" data-group-index="{{ forloop.counter }}">
            <thead>
                <tr>
                    <th>Nombre</th>
                    <th data-sort="asistencia" class="sortable" style="cursor: pointer;">Asistencia <small class="sort-indicator"></small></th>
                    <th>Acciones</th>
                </tr>
            </thead>
                        <tbody>
                                {% for student in group.list %}
                                        {% include 'asistencias/_student_row.html' with student=student %}
                                {% endfor %}
                        </tbody>
    </table>
    </div>
    {% endfor %}
    </div>

{# Client-side filtering + counters: filters table rows by student name (case-insensitive). Debounced. #}
<script>
;(function(){
    var fragment = document.getElementById('daily-attendance-fragment');
    if(!fragment) return;

    function normalize(s){ return (s||'').toLowerCase().trim(); }

    function updateAttendanceCounts(){
        // for each table in the fragment, count present and absent badges in visible rows
        var tables = fragment.querySelectorAll('table[data-group-index]');
        tables.forEach(function(tbl){
            var idx = tbl.getAttribute('data-group-index');
            var presentCount = 0;
            var absentCount = 0;
            tbl.querySelectorAll('tbody tr').forEach(function(r){
                if(r.style.display === 'none') return;
                var badge = r.querySelector('.badge.bg-success');
                var isPresent = badge || (r.querySelectorAll('td')[1] && normalize(r.querySelectorAll('td')[1].textContent).indexOf('presente') !== -1);
                if(isPresent){
                    presentCount += 1;
                } else {
                    absentCount += 1;
                }
            });
            var span = document.getElementById('attendance-count-' + idx);
            if(span) span.textContent = String(presentCount);
            var absentSpan = document.getElementById('absent-count-' + idx);
            if(absentSpan) absentSpan.textContent = String(absentCount);
        });
    }

    // filtering logic
    var input = document.getElementById('attendance-search');
    var timeout = null;
    function filter(){
        var q = normalize(input.value);
        var rows = fragment.querySelectorAll('tr[id^="student-row-"]');
        rows.forEach(function(r){
            var name = r.dataset.name;
            if(!name){
                var cell = r.querySelector('td');
                name = cell ? cell.textContent : '';
                r.dataset.name = name;
            }
            var ok = !q || normalize(name).indexOf(q) !== -1;
            r.style.display = ok ? '' : 'none';
        });
        updateAttendanceCounts();
    }

    if(input){
        input.addEventListener('input', function(){
            clearTimeout(timeout);
            timeout = setTimeout(filter, 150);
        });
    }

    // Sorting: click header to toggle sort by asistencia (Presente/Ausente)
    // Store original order index for rows so we can restore original order reliably
    fragment.querySelectorAll('table[data-group-index] tbody tr').forEach(function(r, i){
        if(!r.dataset.origIndex) r.dataset.origIndex = i;
    });

    function sortTableByAttendance(tbl, mode){
        // mode: 'original' | 'present' | 'absent'
        var tbody = tbl.querySelector('tbody');
        if(!tbody) return;
        var rows = Array.from(tbody.querySelectorAll('tr'));
        var annotated = rows.map(function(r){
            var badge = r.querySelector('.badge.bg-success');
            var present = !!badge || (r.querySelectorAll('td')[1] && normalize(r.querySelectorAll('td')[1].textContent).indexOf('presente') !== -1);
            var orig = parseInt(r.dataset.origIndex || 0, 10);
            return {row: r, present: present, orig: orig};
        });

        if(mode === 'original'){
            annotated.sort(function(a,b){ return a.orig - b.orig; });
        } else if(mode === 'present'){
            annotated.sort(function(a,b){
                if(a.present === b.present) return a.orig - b.orig;
                return a.present ? -1 : 1;
            });
        } else if(mode === 'absent'){
            annotated.sort(function(a,b){
                if(a.present === b.present) return a.orig - b.orig;
                return a.present ? 1 : -1;
            });
        }

        // Re-append rows in new order
        annotated.forEach(function(a){ tbody.appendChild(a.row); });
    }

    // Attach click handlers to sortable headers (cycle: original -> present -> absent -> original)
    fragment.querySelectorAll('th[data-sort="asistencia"]').forEach(function(th){
        var indicator = th.querySelector('.sort-indicator');
        var states = ['original', 'present', 'absent'];
    th.dataset.sortState = 'original';
    if(indicator) indicator.textContent = '';
        th.addEventListener('click', function(){
            var cur = th.dataset.sortState || 'original';
            var next = states[(states.indexOf(cur) + 1) % states.length];
            th.dataset.sortState = next;
            // update indicator
            if(indicator) indicator.textContent = next === 'original' ? '' : (next === 'present' ? '▲' : '▼');
            fragment.querySelectorAll('table[data-group-index]').forEach(function(tbl){ sortTableByAttendance(tbl, next); });
        });
    });

    // Recompute counters on HTMX swaps/updates (when rows or fragment change)
    document.body.addEventListener('htmx:afterSwap', function(e){
        // only update if the swap affected our fragment
        if(e.detail && e.detail.target && fragment.contains(e.detail.target)){
            updateAttendanceCounts();
        }
    });
    document.body.addEventListener('htmx:afterOnLoad', function(e){ updateAttendanceCounts(); });

    // initial compute
    updateAttendanceCounts();
})();
</script>
</div>
