{% extends '_base_layout.html' %}

{% block title %}Inicio{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="card">
        <div class="card-header">
            Bienvenido {{ user_display_name }}
        </div>
        <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-4">
                        <!-- Tailadmin-like customers card style -->
                        <div class="card shadow h-100">
                            <div class="card-body d-flex align-items-center gap-3">
                                <div class="flex-shrink-0">
                                    <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center" style="width:48px;height:48px;">
                                        <i class="fas fa-user-friends"></i>
                                    </div>
                                </div>
                                <div class="flex-grow-1">
                                    <div class="small text-uppercase text-muted">Atletas</div>
                                    <div class="d-flex align-items-baseline">
                                        <h4 class="mb-0 me-2">{{ total_alumnos }}</h4>                                    </div>
                                    <div class="small text-muted">Atletas registrados</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-8">
                        <div class="card shadow h-100">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h6 class="m-0">Estado de pagos ({{ current_month_name|capfirst }})</h6>
                                    <small class="text-muted">% Pagados: <strong id="paidPercent">{{ payment_paid_percent }}%</strong></small>
                                </div>
                                <div class="chart-container" style="height:220px; position:relative;">
                                    <canvas id="chartPayments" style="max-height:100%; width:100%;"></canvas>
                                    <div id="doughnutOverlay" style="position:absolute;inset:0;display:flex;flex-direction:column;justify-content:center;align-items:center;pointer-events:none;">
                                        <h2 id="doughnutPercent" class="mb-0" style="font-size:1.75rem;color:#1f2937">{{ payment_paid_percent }}%</h2>
                                        <p id="doughnutDesc" class="mb-0 text-muted small">Progreso mensual</p>
                                    </div>
                                </div>
                                <div class="mt-2 text-center">
                                    <div class="small text-muted mb-2">Porcentaje de atletas que han registrado al menos un pago en el mes</div>
                                    <div class="d-flex justify-content-center gap-3 mt-1" style="font-size:0.9rem;">
                                        <div><span style="display:inline-block;width:12px;height:12px;background:#667EEA;border-radius:2px;margin-right:6px;"></span>Pagaron</div>
                                        <div><span style="display:inline-block;width:12px;height:12px;background:#E0E7FF;border-radius:2px;margin-right:6px;"></span>No pagaron</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            <div class="row">
                <div class="col-md-12">
                    <h5>Entrenamientos por semana</h5>
                    <div class="chart-container" style="height:300px;">
                        <canvas id="chartSessions" style="max-height:100%; width:100%;"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    // Usuarios chart removed — using only pagos and sesiones charts

    const sessionsLabels = {{ sessions_labels_json|safe }};
    const sessionsCounts = {{ sessions_counts_json|safe }};
    const sessionsData = {
        labels: sessionsLabels,
        datasets: [{
            label: 'Sesiones activas (esta semana)',
            data: sessionsCounts,
            fill: false,
            borderColor: 'rgba(28,200,138,1)',
            tension: 0.4
        }]
    };

    function initCharts(){
        // users chart removed

        const ctxSessions = document.getElementById('chartSessions');
        if(ctxSessions){
            new Chart(ctxSessions, {
                type: 'line',
                data: sessionsData,
                options: {responsive:true, maintainAspectRatio:false}
            });
        }
        // Payments doughnut (same style as users doughnut)
        const ctxPayments = document.getElementById('chartPayments');
        if(ctxPayments){
            const paymentsData = {
                labels: paymentLabels,
                datasets: [{
                    data: paymentCounts,
                    backgroundColor: [
                        'rgba(78,115,223,0.9)', // blue
                        'rgba(233,236,239,0.9)' // light gray
                    ],
                    hoverOffset: 8
                }]
            };
            new Chart(ctxPayments, {
                type: 'doughnut',
                data: paymentsData,
                options: {responsive:true, maintainAspectRatio:false}
            });

            // update overlay percent (first segment / total)
            try{
                const total = (paymentCounts && paymentCounts.length) ? paymentCounts.reduce((a,b)=>a+b,0) : 0;
                const pct = total ? Math.round((paymentCounts[0]/total)*1000)/10 : 0;
                const pctEl = document.getElementById('doughnutPercent');
                if(pctEl) pctEl.textContent = pct + '%';
            }catch(e){console.error('Error computing payment percent', e)}
        }
    }

    // Inicializar cuando DOM esté listo
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initCharts);
    } else {
        initCharts();
    }

    // Payments chart
    const paymentLabels = {{ payment_labels_json|safe }};
    const paymentCounts = {{ payment_counts_json|safe }};

    // New: updateChart function and fetch external radial percent from demo.tailadmin.com
    let paymentsChart = null;

    function updateChart(currentValue, targetValue, previousValue){
        let progreso = targetValue > 0 ? (currentValue / targetValue) * 100 : 0;
        // safety caps
        if(!isFinite(progreso)) progreso = 0;
        if(progreso < 0) progreso = 0;
        if(progreso > 100) progreso = 100;
        const restante = Math.max(0, 100 - progreso);

        const data = {
            labels: ['Progreso','Restante'],
            datasets: [{
                data: [parseFloat(progreso.toFixed(2)), parseFloat(restante.toFixed(2))],
                backgroundColor: ['#667EEA', '#E0E7FF'],
                borderWidth: 0,
                borderRadius: 6
            }]
        };

        const config = {
            type: 'doughnut',
            data: data,
            options: {
                responsive: true,
                cutout: '80%',
                rotation: -Math.PI,
                circumference: Math.PI,
                plugins: { legend: { display: false }, tooltip: { enabled: false } }
            }
        };

        const ctx = document.getElementById('chartPayments');
        if(!ctx) return;

        if(paymentsChart){
            paymentsChart.data = data;
            paymentsChart.update();
        } else {
            paymentsChart = new Chart(ctx, config);
        }

        // debug logs to inspect values in console
        console.log('updateChart called', { currentValue, targetValue, progreso, restante, data: data.datasets[0].data });

        // update overlay
    document.getElementById('doughnutPercent').textContent = Math.round(progreso * 10) / 10 + '%';
        const descEl = document.getElementById('doughnutDesc');
        if(previousValue !== undefined && previousValue !== null){
            const prevPct = previousValue > 0 ? (previousValue / targetValue) * 100 : 0;
            const delta = Math.round((progreso - prevPct) * 10) / 10;
            descEl.textContent = (delta>0?'+':'') + delta + '% vs prev';
        } else {
            descEl.textContent = 'Progreso mensual';
        }
    }

    (async function(){
        // fallback data (counts)
        const fallbackCurrent = {{ alumnos_pagaron_count|default:0 }};
        const fallbackTarget = {{ total_alumnos|default:1 }} || 1;

        try{
            const res = await fetch('https://demo.tailadmin.com/');
            const html = await res.text();
            const tmp = document.createElement('div'); tmp.innerHTML = html;
            // apexcharts data label
            const label = tmp.querySelector('.apexcharts-datalabel-value');
            if(label){
                const pctText = label.textContent.trim().replace('%','');
                const pct = parseFloat(pctText);
                if(!isNaN(pct)){
                    updateChart(pct, 100);
                    return;
                }
            }
        }catch(e){
            // CORS/network error; fall back
        }

        // fallback: use local counts
        updateChart(fallbackCurrent, fallbackTarget);
    })();
</script>
{% endblock %}
